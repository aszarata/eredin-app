<!DOCTYPE html>
<html>
<head>
    <title>Image Processing App</title>
    <style>
        body { font-family: Arial; margin: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .image-container { display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0; }
        .image-box { border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
        .image-box img { max-width: 300px; max-height: 300px; }
        .controls { margin: 10px 0; }
        button { margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.reject { background: #dc3545; }
        button.reject:hover { background: #c82333; }
        .tabs { display: flex; gap: 10px; margin: 20px 0; }
        .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #ddd; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Image Processing Application</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('upload')">Upload & Process</div>
            <div class="tab" onclick="showTab('gallery')">Gallery</div>
        </div>
        
        <div id="upload" class="tab-content active">
            <h2>Upload Image</h2>
            <form id="uploadForm">
                <input type="file" id="imageInput" accept="image/*">
                <button type="button" onclick="uploadImage()">Upload</button>
            </form>
            
            <div id="processingArea" style="display: none;">
                <h3>Image Preview</h3>
                <div class="image-container">
                    <div class="image-box">
                        <img id="previewImage">
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="approveImage()">Approve & Detect</button>
                    <button class="reject" onclick="rejectImage()">Reject</button>
                </div>
            </div>
            
            <div id="detectionArea" style="display: none;">
                <h3>Detection Results</h3>
                <div class="image-container">
                    <div class="image-box">
                        <img id="detectionImage">
                    </div>
                </div>
                
                <div class="controls">
                    <button onclick="saveDetections()">Save & Crop Bounding Boxes</button>
                </div>
            </div>
        </div>
        
        <div id="gallery" class="tab-content">
            <h2>Image Gallery</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="showGalleryTab('original')">Original Images</div>
                <div class="tab" onclick="showGalleryTab('bbox')">Bounding Boxes</div>
            </div>
            
            <div id="originalGallery" class="tab-content active">
                <div class="image-container" id="originalImages"></div>
            </div>
            
            <div id="bboxGallery" class="tab-content">
                <div class="image-container" id="bboxImages"></div>
            </div>
        </div>
    </div>

    <script>
        let currentImageId = null;
        let currentBoxes = [];
        
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        function showGalleryTab(tabName) {
            document.querySelectorAll('#gallery .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#gallery .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Gallery').classList.add('active');
            event.target.classList.add('active');
        }
        
        function uploadImage() {
            const fileInput = document.getElementById('imageInput');
            if (!fileInput.files[0]) return;
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentImageId = data.image_id;
                    document.getElementById('previewImage').src = data.image_url;
                    document.getElementById('processingArea').style.display = 'block';
                }
            });
        }
        
        function approveImage() {
            fetch(`/approve/${currentImageId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('detectionImage').src = data.bbox_image;
                    document.getElementById('processingArea').style.display = 'none';
                    document.getElementById('detectionArea').style.display = 'block';
                    currentBoxes = data.boxes;
                }
            });
        }
        
        function rejectImage() {
            fetch(`/reject/${currentImageId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resetUpload();
                }
            });
        }
        
        function saveDetections() {
            fetch(`/save_bboxes/${currentImageId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ boxes: currentBoxes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Bounding boxes saved and cropped!');
                    resetUpload();
                    loadGallery();
                }
            });
        }
        
        function resetUpload() {
            document.getElementById('imageInput').value = '';
            document.getElementById('processingArea').style.display = 'none';
            document.getElementById('detectionArea').style.display = 'none';
            currentImageId = null;
            currentBoxes = [];
        }
        
        function loadGallery() {
            fetch('/get_gallery')
            .then(response => response.json())
            .then(data => {
                const originalContainer = document.getElementById('originalImages');
                const bboxContainer = document.getElementById('bboxImages');
                
                originalContainer.innerHTML = '';
                bboxContainer.innerHTML = '';
                
                data.original_images.forEach(img => {
                    originalContainer.innerHTML += `
                        <div class="image-box">
                            <img src="${img.url}">
                            <p>${new Date(img.created_at).toLocaleString()}</p>
                        </div>
                    `;
                });
                
                data.bbox_images.forEach(img => {
                    bboxContainer.innerHTML += `
                        <div class="image-box">
                            <img src="${img.url}">
                            <p>${new Date(img.created_at).toLocaleString()}</p>
                        </div>
                    `;
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            loadGallery();
        });
    </script>
</body>
</html>